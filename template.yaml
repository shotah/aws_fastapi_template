AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  AWS_FASTAPI_TEMPLATE

  Powertools example with enterprise IAM and resource configurations

Parameters:
  # IAM Role for Lambda (pre-created by security team)
  # Uncomment the Role property in HelloWorldFunction to use this
  LambdaExecutionRoleArn:
    Type: String
    Description: ARN of the pre-created IAM role for Lambda execution
    # Example: arn:aws:iam::123456789012:role/my-lambda-execution-role
    Default: ""

  # Global environment variables (also used as API Gateway stage name)
  Environment:
    Type: String
    Description: Environment name (used for tags, env vars, and API Gateway stage)
    Default: Dev
    AllowedValues:
      - Sandbox
      - Dev
      - Prod

  LogLevel:
    Type: String
    Description: Application log level
    Default: INFO
    AllowedValues:
      - DEBUG
      - INFO
      - WARNING
      - ERROR
      - CRITICAL

  # Email configuration for SES
  FromEmail:
    Type: String
    Description: Verified email address to send emails from (must be verified in SES)
    Default: "your-verified-email@example.com"

  AdminEmail:
    Type: String
    Description: Admin email address to receive scheduled emails
    Default: "admin@example.com"

  # Custom Domain Configuration (Optional)
  # Stack name is automatically prepended to avoid collisions across services/stacks
  # Final domain will be: ${AWS::StackName}.${BaseDomain}
  BaseDomain:
    Type: String
    Description: Base domain for API (e.g., example.com). Stack name will be prepended. Leave empty to skip custom domain.
    Default: ""

  HostedZoneId:
    Type: String
    Description: Route53 Hosted Zone ID for base domain. Required if BaseDomain is set.
    Default: ""

  # VPC Configuration (Required for NIST 800-53 SC-7 Boundary Protection)
  # Lambda will be deployed in private subnets with controlled egress
  VpcId:
    Type: String
    Description: VPC ID for Lambda network isolation. Leave empty to skip VPC configuration.
    Default: ""

  SubnetIds:
    Type: CommaDelimitedList
    Description: Comma-separated list of private subnet IDs (min 2 for HA). Required if VpcId is set.
    Default: ""

  SecurityGroupIds:
    Type: CommaDelimitedList
    Description: Comma-separated list of security group IDs. Required if VpcId is set.
    Default: ""

  # Cross-Stack S3 Access (Import another service's bucket)
  # Use Fn::ImportValue in the parameter override to import from another stack:
  #   ExternalBucketArn=!ImportValue other-stack-DataBucketArn
  # Or pass the ARN directly:
  #   ExternalBucketArn=arn:aws:s3:::other-bucket-name
  ExternalBucketArn:
    Type: String
    Description: ARN of an external S3 bucket this Lambda needs access to. Leave empty to skip.
    Default: ""

Conditions:
  # Condition to check if custom domain should be configured
  HasCustomDomain: !Not [!Equals [!Ref BaseDomain, ""]]
  # Condition to check if VPC configuration should be applied (NIST 800-53 SC-7)
  HasVpcConfig: !Not [!Equals [!Ref VpcId, ""]]
  # Condition to check if external bucket access is needed
  HasExternalBucket: !Not [!Equals [!Ref ExternalBucketArn, ""]]

Globals: # https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification-template-anatomy-globals.html
  Function:
    Timeout: 150
    MemorySize: 512
    Runtime: python3.13
    Tracing: Active
    # You can add LoggingConfig parameters such as the Logformat, Log Group, and SystemLogLevel or ApplicationLogLevel. Learn more here https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html#sam-function-loggingconfig.
    LoggingConfig:
      LogFormat: JSON
    # Global environment variables for all functions
    Environment:
      Variables:
        ENVIRONMENT: !Ref Environment
        LOG_LEVEL: !Ref LogLevel
    # Global tags for all functions
    Tags:
      Environment: !Ref Environment
      CostCenter: engineering
      ManagedBy: SAM

Resources:
  # ============================================================================
  # VPC Endpoints (Required when Lambda is in VPC without NAT Gateway)
  # ============================================================================
  # When Lambda is deployed in a VPC (NIST 800-53 SC-7), it loses direct internet
  # access. Create VPC Endpoints for AWS services the Lambda needs to call:
  #
  # Required for this template:
  #   - com.amazonaws.REGION.s3 (Gateway endpoint - free)
  #   - com.amazonaws.REGION.email-smtp (Interface endpoint for SES)
  #
  # Optional (based on your usage):
  #   - com.amazonaws.REGION.dynamodb (Gateway endpoint - free)
  #   - com.amazonaws.REGION.sqs (Interface endpoint)
  #   - com.amazonaws.REGION.secretsmanager (Interface endpoint)
  #   - com.amazonaws.REGION.logs (Interface endpoint for CloudWatch Logs)
  #
  # Example VPC Endpoint (uncomment and modify as needed):
  # S3VpcEndpoint:
  #   Type: AWS::EC2::VPCEndpoint
  #   Condition: HasVpcConfig
  #   Properties:
  #     VpcId: !Ref VpcId
  #     ServiceName: !Sub "com.amazonaws.${AWS::Region}.s3"
  #     VpcEndpointType: Gateway
  #     RouteTableIds:
  #       - rtb-xxxxxxxxx  # Replace with your private subnet route table IDs
  #
  # SESVpcEndpoint:
  #   Type: AWS::EC2::VPCEndpoint
  #   Condition: HasVpcConfig
  #   Properties:
  #     VpcId: !Ref VpcId
  #     ServiceName: !Sub "com.amazonaws.${AWS::Region}.email-smtp"
  #     VpcEndpointType: Interface
  #     SubnetIds: !Ref SubnetIds
  #     SecurityGroupIds: !Ref SecurityGroupIds
  #     PrivateDnsEnabled: true

  # ============================================================================
  # ACM Certificate (Auto-created and validated via Route53)
  # ============================================================================
  ApiCertificate:
    Type: AWS::CertificateManager::Certificate
    Condition: HasCustomDomain
    Properties:
      DomainName: !Sub "${AWS::StackName}.${BaseDomain}"
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Sub "${AWS::StackName}.${BaseDomain}"
          HostedZoneId: !Ref HostedZoneId
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-api-cert"
        - Key: ManagedBy
          Value: SAM

  # ============================================================================
  # API Gateway (Explicit Definition)
  # ============================================================================
  # We define the API explicitly to control the stage name per environment
  # Custom domain is automatically configured if DomainName parameter is provided
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub "${AWS::StackName}-api"
      StageName: !Ref Environment # Use Environment as the stage name
      TracingEnabled: true
      # Custom domain configuration (only applies if BaseDomain parameter is set)
      # Final domain will be: ${AWS::StackName}.${BaseDomain}
      Domain:
        DomainName:
          !If [
            HasCustomDomain,
            !Sub "${AWS::StackName}.${BaseDomain}",
            !Ref "AWS::NoValue",
          ]
        CertificateArn:
          !If [HasCustomDomain, !Ref ApiCertificate, !Ref "AWS::NoValue"]
        EndpointConfiguration: REGIONAL # REGIONAL is faster and cheaper than EDGE
        Route53:
          HostedZoneId:
            !If [HasCustomDomain, !Ref HostedZoneId, !Ref "AWS::NoValue"]
      Tags:
        Environment: !Ref Environment
        CostCenter: engineering
        ManagedBy: SAM
      # Inherit auth configuration from Globals.Api if needed

  # ============================================================================
  # IAM Policy Example (For AWS_IAM Authorization)
  # ============================================================================
  # If using AWS_IAM authorization, clients need an IAM policy like this:
  #
  # {
  #   "Version": "2012-10-17",
  #   "Statement": [
  #     {
  #       "Effect": "Allow",
  #       "Action": "execute-api:Invoke",
  #       "Resource": "arn:aws:execute-api:REGION:ACCOUNT_ID:API_ID/STAGE/METHOD/PATH"
  #     }
  #   ]
  # }
  #
  # Specific examples:
  #   - All methods/paths: "arn:aws:execute-api:us-east-1:123456789012:abc123xyz/Prod/*/*"
  #   - Specific endpoint:  "arn:aws:execute-api:us-east-1:123456789012:abc123xyz/Prod/GET/hello"
  #   - Users endpoints:    "arn:aws:execute-api:us-east-1:123456789012:abc123xyz/Prod/*/users/*"
  #
  # Attach this policy to:
  #   - IAM User/Role that will call the API
  #   - Service (Lambda, ECS, EC2) that needs to invoke the API
  #
  # After deployment, get your API ID from outputs or AWS Console:
  #   aws cloudformation describe-stacks --stack-name aws-fastapi-template-prod \
  #     --query 'Stacks[0].Outputs[?OutputKey==`HelloWorldApi`].OutputValue' --output text

  # ============================================================================
  # Lambda Authorizer (Commented Example - Option 2)
  # ============================================================================
  # Uncomment to add Lambda authorizer for JWT/custom auth:
  # ApiAuthorizerFunction:
  #   Type: AWS::Serverless::Function
  #   Properties:
  #     CodeUri: ./authorizer  # Create this directory with authorizer code
  #     Handler: authorizer.lambda_handler
  #     Runtime: python3.13
  #     Description: Lambda authorizer for API Gateway
  #     Environment:
  #       Variables:
  #         JWT_SECRET: !Ref JwtSecret  # Add JwtSecret to Parameters
  #         # Or use Secrets Manager:
  #         # JWT_SECRET_ARN: !Ref JwtSecretArn
  #
  # Example authorizer code (authorizer/authorizer.py):
  # ```python
  # import json
  # import os
  # import jwt  # PyJWT library
  #
  # def lambda_handler(event, context):
  #     token = event['authorizationToken'].replace('Bearer ', '')
  #     try:
  #         decoded = jwt.decode(token, os.getenv('JWT_SECRET'), algorithms=['HS256'])
  #         return {
  #             'principalId': decoded['sub'],
  #             'policyDocument': {
  #                 'Version': '2012-10-17',
  #                 'Statement': [{
  #                     'Action': 'execute-api:Invoke',
  #                     'Effect': 'Allow',
  #                     'Resource': event['methodArn']
  #                 }]
  #             },
  #             'context': {'user_id': decoded['sub'], 'email': decoded.get('email')}
  #         }
  #     except:
  #         raise Exception('Unauthorized')
  # ```

  # ============================================================================
  # Lambda Function
  # ============================================================================
  HelloWorldFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html
    Properties:
      Handler: app.lambda_handler
      CodeUri: ./src
      Description: Hello World function
      Architectures:
        - x86_64
      Tracing: Active
      # To use a pre-created IAM role:
      # 1. Uncomment the line below
      # 2. Either set LambdaExecutionRoleArn parameter or replace with actual ARN
      # Role: !Ref LambdaExecutionRoleArn
      # If Role is not specified, SAM will create one with basic Lambda execution permissions
      # VPC Configuration (NIST 800-53 SC-7 Boundary Protection)
      # Enables network isolation in private subnets with controlled egress
      VpcConfig: !If
        - HasVpcConfig
        - SecurityGroupIds: !Ref SecurityGroupIds
          SubnetIds: !Ref SubnetIds
        - !Ref "AWS::NoValue"
      # IAM Policies for the Lambda function
      Policies:
        # VPC access policy - required for Lambda to create ENIs in VPC (NIST 800-53 SC-7)
        - !If
          - HasVpcConfig
          - Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                  - ec2:AssignPrivateIpAddresses
                  - ec2:UnassignPrivateIpAddresses
                Resource: "*"
          - !Ref "AWS::NoValue"
        # Allow S3 access to the DataBucket
        - S3CrudPolicy:
            BucketName: !Ref DataBucket
        # Allow sending emails via SES
        - SESCrudPolicy:
            IdentityName: "*"
        # Cross-stack S3 access - allow access to external bucket from another service
        - !If
          - HasExternalBucket
          - Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Ref ExternalBucketArn
                  - !Sub "${ExternalBucketArn}/*"
          - !Ref "AWS::NoValue"
        # Add more policies as needed:
        # - DynamoDBCrudPolicy:
        #     TableName: !Ref MyTable
        # - SQSSendMessagePolicy:
        #     QueueName: !GetAtt MyQueue.QueueName
      Events:
        HealthCheck:
          Type: Api # Health check endpoint for monitoring
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /health
            Method: GET
            # ============================================================
            # Endpoint Authorization (Uncomment to require authentication)
            # ============================================================
            # Option 1: AWS IAM (Recommended for enterprise/service-to-service)
            # Auth:
            #   Authorizer: AWS_IAM
            #
            # Option 2: Lambda Authorizer (for custom JWT/OAuth)
            # Auth:
            #   Authorizer: LambdaTokenAuthorizer
            #
            # Option 3: Make endpoint public (if global auth is enabled)
            # Auth:
            #   Authorizer: NONE
            Auth:
              Authorizer: AWS_IAM
        HelloPath:
          Type: Api # More info about API Event Source: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-property-function-api.html
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /hello
            Method: GET
            Auth:
              Authorizer: AWS_IAM
        GetUser:
          Type: Api # Get user by ID
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /users/{user_id}
            Method: GET
            Auth:
              Authorizer: AWS_IAM
        CreateUser:
          Type: Api # Create new user
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /users
            Method: POST
            Auth:
              Authorizer: AWS_IAM
        UploadFile:
          Type: Api # Upload file to S3
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /files
            Method: POST
            Auth:
              Authorizer: AWS_IAM
        ListFiles:
          Type: Api # List files in S3
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /files
            Method: GET
            Auth:
              Authorizer: AWS_IAM
        DownloadFile:
          Type: Api # Download file from S3
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /files/{file_id}
            Method: GET
            Auth:
              Authorizer: AWS_IAM
        DeleteFile:
          Type: Api # Delete file from S3
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /files/{file_id}
            Method: DELETE
            Auth:
              Authorizer: AWS_IAM
        TriggerNightlyEmail:
          Type: Api # Manual trigger for nightly email (also triggered by EventBridge)
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /tasks/nightly-email
            Method: POST
            Auth:
              Authorizer: AWS_IAM
        NightlySchedule:
          Type: Schedule # More info: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-property-function-schedule.html
          Properties:
            Description: Trigger Lambda nightly at midnight UTC to send emails
            Enabled: true
            # Cron format: cron(Minutes Hours Day-of-month Month Day-of-week Year)
            # This runs at 00:00 UTC every day
            Schedule: cron(0 0 * * ? *)
            # Alternative: Use rate expression for simpler schedules
            # Schedule: rate(1 day)
            # EventBridge sends a minimal API Gateway-compatible event format
            Input: |
              {
                "httpMethod": "POST",
                "path": "/tasks/nightly-email",
                "resource": "/tasks/nightly-email",
                "requestContext": {
                  "requestId": "eventbridge-scheduled-task"
                },
                "isBase64Encoded": false
              }
      # Environment variables for Lambda function
      # - For local dev: Use env.json (see env.json.example)
      # - For deployment: Set values below or use Parameters
      # - For secrets: Use AWS Secrets Manager (see examples below)
      Environment:
        Variables:
          # AWS Lambda Powertools configuration
          # https://awslabs.github.io/aws-lambda-powertools-python/#environment-variables
          POWERTOOLS_SERVICE_NAME: PowertoolsHelloWorld
          POWERTOOLS_METRICS_NAMESPACE: Powertools
          ENVIRONMENT: !Ref Environment # Uses Parameter from above
          # Add your custom environment variables here:
          # API_KEY: !Ref ApiKeyParameter
          # DATABASE_URL: !Sub "https://${DatabaseEndpoint}"
          DATA_BUCKET: !Ref DataBucket # Reference S3 bucket
          # Email configuration for SES
          FROM_EMAIL: !Ref FromEmail
          ADMIN_EMAIL: !Ref AdminEmail
          # SQS_QUEUE_URL: !Ref ProcessingQueue  # Reference SQS queue
          # For secrets, use AWS Secrets Manager:
          # SECRET_ARN: arn:aws:secretsmanager:region:account:secret:name
          # Then in code: boto3.client('secretsmanager').get_secret_value(SecretId=os.getenv('SECRET_ARN'))
      Tags:
        LambdaPowertools: python
        # Environment, CostCenter, ManagedBy tags inherited from Globals.Function.Tags

  # ============================================================================
  # SES Email Identity (Commented Example - Added in CloudFormation June 2022)
  # ============================================================================
  # Uncomment to automatically verify a domain or email address in SES:
  # SESEmailIdentity:
  #   Type: AWS::SES::EmailIdentity
  #   Properties:
  #     EmailIdentity: !Ref FromEmail  # Can be email or domain (e.g., "example.com")
  #     # Optional: Configure DKIM signing
  #     DkimSigningAttributes:
  #       NextSigningKeyLength: RSA_2048_BIT
  #     # Optional: Add configuration set
  #     # ConfigurationSetAttributes:
  #     #   ConfigurationSetName: !Ref MySESConfigurationSet
  #
  # # If using a domain (not individual email), automatically add DKIM DNS records to Route53:
  # # (Skip this if you're verifying individual emails or using external DNS)
  # SESRoute53DKIMRecords:
  #   Type: AWS::Route53::RecordSetGroup
  #   Properties:
  #     HostedZoneId: Z1234567890ABC  # Replace with your Route53 Hosted Zone ID
  #     RecordSets:
  #       - Name: !GetAtt SESEmailIdentity.DkimDNSTokenName1
  #         Type: CNAME
  #         TTL: '3600'
  #         ResourceRecords:
  #           - !GetAtt SESEmailIdentity.DkimDNSTokenValue1
  #       - Name: !GetAtt SESEmailIdentity.DkimDNSTokenName2
  #         Type: CNAME
  #         TTL: '3600'
  #         ResourceRecords:
  #           - !GetAtt SESEmailIdentity.DkimDNSTokenValue2
  #       - Name: !GetAtt SESEmailIdentity.DkimDNSTokenName3
  #         Type: CNAME
  #         TTL: '3600'
  #         ResourceRecords:
  #           - !GetAtt SESEmailIdentity.DkimDNSTokenValue3
  #
  # # Optional: SES Configuration Set for tracking opens, clicks, bounces, etc.
  # # MySESConfigurationSet:
  # #   Type: AWS::SES::ConfigurationSet
  # #   Properties:
  # #     Name: !Sub "${AWS::StackName}-ses-config"
  # #     TrackingOptions:
  # #       CustomRedirectDomain: track.example.com  # Optional custom tracking domain
  # #
  # # # Optional: Send SES events (bounces, complaints, etc.) to CloudWatch
  # # MySESEventDestination:
  # #   Type: AWS::SES::ConfigurationSetEventDestination
  # #   Properties:
  # #     ConfigurationSetName: !Ref MySESConfigurationSet
  # #     EventDestination:
  # #       Name: CloudWatchDestination
  # #       Enabled: true
  # #       MatchingEventTypes:
  # #         - send
  # #         - bounce
  # #         - complaint
  # #         - delivery
  # #       CloudWatchDestination:
  # #         DimensionConfigurations:
  # #           - DimensionName: ses:configuration-set
  # #             DimensionValueSource: messageTag
  # #             DefaultDimensionValue: !Ref MySESConfigurationSet

  # ============================================================================
  # S3 Bucket for Application Data
  # ============================================================================
  DataBucket:
    Type: AWS::S3::Bucket
    Properties:
      # No BucketName - let CloudFormation auto-generate for global uniqueness
      # Result: "aws-fastapi-template-databucket-a1b2c3d4e5f6"
      # Enable versioning for data protection
      VersioningConfiguration:
        Status: Enabled
      # Encryption at rest
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      # Block public access (security best practice)
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      # Lifecycle rules (optional - uncomment to enable)
      # LifecycleConfiguration:
      #   Rules:
      #     - Id: DeleteOldVersions
      #       Status: Enabled
      #       NoncurrentVersionExpirationInDays: 90
      #     - Id: TransitionToIA
      #       Status: Enabled
      #       Transitions:
      #         - TransitionInDays: 30
      #           StorageClass: STANDARD_IA
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: CostCenter
          Value: engineering
        - Key: ManagedBy
          Value: SAM
        - Key: Purpose
          Value: Application Data Storage

  # ============================================================================
  # SQS Queue (Commented Example)
  # ============================================================================
  # ProcessingQueue:
  #   Type: AWS::SQS::Queue
  #   Properties:
  #     QueueName: !Sub "${AWS::StackName}-processing-${Environment}"
  #     # Message retention period (4 days)
  #     MessageRetentionPeriod: 345600
  #     # Visibility timeout (should be 6x Lambda timeout)
  #     VisibilityTimeout: 90
  #     # Enable encryption at rest
  #     SqsManagedSseEnabled: true
  #     # Dead letter queue configuration
  #     RedrivePolicy:
  #       deadLetterTargetArn: !GetAtt ProcessingQueueDLQ.Arn
  #       maxReceiveCount: 3
  #     Tags:
  #       Environment: !Ref Environment
  #       CostCenter: engineering
  #       ManagedBy: SAM
  #       Purpose: Async Processing Queue
  #
  # # Dead Letter Queue for failed messages
  # ProcessingQueueDLQ:
  #   Type: AWS::SQS::Queue
  #   Properties:
  #     QueueName: !Sub "${AWS::StackName}-processing-dlq-${Environment}"
  #     MessageRetentionPeriod: 1209600  # 14 days
  #     SqsManagedSseEnabled: true
  #     Tags:
  #       Environment: !Ref Environment
  #       CostCenter: engineering
  #       ManagedBy: SAM
  #       Purpose: Dead Letter Queue
  #
  # # Lambda Event Source Mapping for SQS (uncomment to use)
  # # ProcessingQueueEventSource:
  # #   Type: AWS::Lambda::EventSourceMapping
  # #   Properties:
  # #     EventSourceArn: !GetAtt ProcessingQueue.Arn
  # #     FunctionName: !Ref HelloWorldFunction
  # #     BatchSize: 10
  # #     MaximumBatchingWindowInSeconds: 5

  # ============================================================================
  # CloudWatch Alarms
  # ============================================================================
  LambdaErrorsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-lambda-errors"
      AlarmDescription: Alert when Lambda function has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300 # 5 minutes
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: FunctionName
          Value: !Ref HelloWorldFunction
      # Uncomment to send alerts to SNS/Email:
      # AlarmActions:
      #   - !Ref AlertTopic

  LambdaThrottlesAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-lambda-throttles"
      AlarmDescription: Alert when Lambda function is throttled
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300 # 5 minutes
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: FunctionName
          Value: !Ref HelloWorldFunction
      # Uncomment to send alerts to SNS/Email:
      # AlarmActions:
      #   - !Ref AlertTopic

  # Uncomment to create SNS topic for alarm notifications:
  # AlertTopic:
  #   Type: AWS::SNS::Topic
  #   Properties:
  #     TopicName: !Sub "${AWS::StackName}-alerts"
  #     Subscription:
  #       - Endpoint: your-email@example.com
  #         Protocol: email

  # ============================================================================
  # Application Insights
  # ============================================================================
  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Sub: ApplicationInsights-SAM-${AWS::StackName}
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
  ApplicationInsightsMonitoring:
    Type: AWS::ApplicationInsights::Application
    Properties:
      ResourceGroupName:
        Ref: ApplicationResourceGroup
      AutoConfigurationEnabled: "true"
Outputs:
  # ============================================================================
  # API Outputs
  # ============================================================================
  ApiBaseUrl:
    Description: "API Gateway base URL - append endpoint paths (e.g., /hello, /users, /health)"
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.${AWS::URLSuffix}/${Environment}"
    Export:
      Name: !Sub "${AWS::StackName}-ApiBaseUrl"

  # ============================================================================
  # Lambda Outputs
  # ============================================================================
  HelloWorldFunction:
    Description: Hello World Lambda Function ARN
    Value: !GetAtt HelloWorldFunction.Arn

  # HelloWorldFunctionRole:
  #   Description: IAM Role used by Lambda function
  #   Value: !Ref LambdaExecutionRoleArn  # Only works if Role is specified

  # ============================================================================
  # CloudWatch Alarms Outputs
  # ============================================================================
  LambdaErrorsAlarm:
    Description: CloudWatch Alarm for Lambda errors
    Value: !GetAtt LambdaErrorsAlarm.Arn

  LambdaThrottlesAlarm:
    Description: CloudWatch Alarm for Lambda throttles
    Value: !GetAtt LambdaThrottlesAlarm.Arn

  # ============================================================================
  # S3 Bucket Outputs
  # ============================================================================
  DataBucketName:
    Description: S3 Data Bucket Name (auto-generated by CloudFormation)
    Value: !Ref DataBucket
    Export:
      Name: !Sub "${AWS::StackName}-DataBucketName"

  DataBucketArn:
    Description: S3 Data Bucket ARN (for IAM policies in other stacks)
    Value: !GetAtt DataBucket.Arn
    Export:
      Name: !Sub "${AWS::StackName}-DataBucketArn"

  # ============================================================================
  # Custom Domain Outputs
  # ============================================================================
  CustomDomainName:
    Condition: HasCustomDomain
    Description: Custom domain name for the API (stack-namespaced)
    Value: !Sub "${AWS::StackName}.${BaseDomain}"

  CustomDomainUrl:
    Condition: HasCustomDomain
    Description: Full URL for the custom domain
    Value: !Sub "https://${AWS::StackName}.${BaseDomain}/"

  CertificateArn:
    Condition: HasCustomDomain
    Description: ARN of the auto-generated ACM certificate
    Value: !Ref ApiCertificate
    Export:
      Name: !Sub "${AWS::StackName}-CertificateArn"

  # ============================================================================
  # VPC Outputs (NIST 800-53 SC-7)
  # ============================================================================
  LambdaVpcId:
    Condition: HasVpcConfig
    Description: VPC ID where Lambda is deployed for network isolation
    Value: !Ref VpcId

  LambdaSubnets:
    Condition: HasVpcConfig
    Description: Subnet IDs where Lambda ENIs are created
    Value: !Join [",", !Ref SubnetIds]

  # ============================================================================
  # S3 Outputs (Commented Examples)
  # ============================================================================
  # DataBucketName:
  #   Description: Name of the S3 bucket for data storage
  #   Value: !Ref DataBucket
  #   Export:
  #     Name: !Sub "${AWS::StackName}-DataBucket"
  #
  # DataBucketArn:
  #   Description: ARN of the S3 bucket
  #   Value: !GetAtt DataBucket.Arn

  # ============================================================================
  # SQS Outputs (Commented Examples)
  # ============================================================================
  # ProcessingQueueUrl:
  #   Description: URL of the processing queue
  #   Value: !Ref ProcessingQueue
  #   Export:
  #     Name: !Sub "${AWS::StackName}-ProcessingQueue"
  #
  # ProcessingQueueArn:
  #   Description: ARN of the processing queue
  #   Value: !GetAtt ProcessingQueue.Arn
  #
  # ProcessingQueueDLQUrl:
  #   Description: URL of the processing dead letter queue
  #   Value: !Ref ProcessingQueueDLQ
